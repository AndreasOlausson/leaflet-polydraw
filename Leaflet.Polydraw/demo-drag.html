<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaflet Polydraw - Polygon Drag Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        #map {
            height: 600px;
            width: 100%;
            border: 2px solid #ccc;
            border-radius: 8px;
        }
        .info {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .controls {
            margin-top: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .event-log {
            margin-top: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="info">
        <h1>üéØ Leaflet Polydraw - Polygon Drag Feature Demo</h1>
        <p><strong>Instructions:</strong></p>
        <ol>
            <li>Click the <strong>Draw</strong> button (pencil icon) in the map control</li>
            <li>Draw a polygon by clicking and dragging on the map</li>
            <li>Once the polygon is created, you can <strong>drag it around</strong> by clicking and dragging the polygon itself</li>
            <li>Use the controls below to enable/disable dragging or clear all polygons</li>
        </ol>
        <p><em>Note: The polygon will become semi-transparent while being dragged and return to normal opacity when dropped.</em></p>
    </div>

    <div id="map"></div>

    <div class="controls">
        <button id="enableDrag">Enable Polygon Dragging</button>
        <button id="disableDrag">Disable Polygon Dragging</button>
        <button id="clearAll">Clear All Polygons</button>
        <button id="addSample">Add Sample Polygon</button>
    </div>

    <div class="event-log" id="eventLog">
        <strong>Event Log:</strong><br>
        Ready to draw and drag polygons...<br>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://unpkg.com/concaveman@1.1.0/concaveman.min.js"></script>
    <script type="module">
        // Import the Polydraw module (in a real implementation, this would be from the built dist file)
        // For demo purposes, we'll create a simplified version

        // Initialize the map
        const map = L.map('map').setView([59.3293, 18.0686], 10); // Stockholm

        // Add tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Add Polydraw control (this would normally be imported from the built library)
        // For demo purposes, we'll simulate the functionality
        let polygons = [];
        let dragEnabled = true;
        let currentPolygon = null;

        // Event logging
        function logEvent(message) {
            const log = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString();
            log.innerHTML += `[${timestamp}] ${message}<br>`;
            log.scrollTop = log.scrollHeight;
        }

        // Create a simple drawing control
        const drawControl = L.control({ position: 'topleft' });
        drawControl.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
            div.innerHTML = `
                <a href="#" title="Draw Polygon" style="background-color: #fff; color: #000; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; text-decoration: none;">
                    ‚úèÔ∏è
                </a>
            `;
            
            div.onclick = function(e) {
                e.preventDefault();
                startDrawing();
            };
            
            return div;
        };
        drawControl.addTo(map);

        // Simple drawing functionality
        let isDrawing = false;
        let drawingPoints = [];

        function startDrawing() {
            if (isDrawing) return;
            
            isDrawing = true;
            drawingPoints = [];
            logEvent('Started drawing polygon');
            
            map.on('click', onMapClick);
            map.on('dblclick', finishDrawing);
        }

        function onMapClick(e) {
            if (!isDrawing) return;
            
            drawingPoints.push([e.latlng.lat, e.latlng.lng]);
            
            // Visual feedback
            if (drawingPoints.length === 1) {
                currentPolygon = L.polygon(drawingPoints, {
                    color: '#50622b',
                    fillColor: '#b4cd8a',
                    fillOpacity: 0.5
                }).addTo(map);
            } else {
                currentPolygon.setLatLngs(drawingPoints);
            }
        }

        function finishDrawing() {
            if (!isDrawing || drawingPoints.length < 3) return;
            
            isDrawing = false;
            map.off('click', onMapClick);
            map.off('dblclick', finishDrawing);
            
            // Create final polygon with drag functionality
            if (currentPolygon) {
                map.removeLayer(currentPolygon);
            }
            
            const polygon = L.polygon(drawingPoints, {
                color: '#50622b',
                fillColor: '#b4cd8a',
                fillOpacity: 0.5
            }).addTo(map);
            
            // Enable dragging if configured
            if (dragEnabled) {
                enablePolygonDragging(polygon);
            }
            
            polygons.push(polygon);
            logEvent(`Created polygon with ${drawingPoints.length} points`);
            drawingPoints = [];
            currentPolygon = null;
        }

        function enablePolygonDragging(polygon) {
            if (!polygon.dragging) return;
            
            polygon.dragging.enable();
            
            // Add hover cursor
            polygon.on('mouseover', function(e) {
                map.getContainer().style.cursor = 'grab';
            });
            
            polygon.on('mouseout', function(e) {
                if (!polygon._isDragging) {
                    map.getContainer().style.cursor = '';
                }
            });
            
            polygon.on('dragstart', function(e) {
                logEvent('Polygon drag started - markers will fade out');
                polygon._isDragging = true;
                e.target.setStyle({ opacity: 0.7 });
                map.dragging.disable();
                map.getContainer().style.cursor = 'move';
                
                // Simulate marker fade out (in real implementation, markers would be handled automatically)
                logEvent('Markers fading out during drag...');
            });
            
            polygon.on('drag', function(e) {
                // Optional: real-time updates during drag
            });
            
            polygon.on('dragend', function(e) {
                logEvent('Polygon drag ended - markers will fade back in');
                polygon._isDragging = false;
                e.target.setStyle({ opacity: 1.0 });
                map.dragging.enable();
                map.getContainer().style.cursor = '';
                
                // Simulate marker fade in (in real implementation, markers would be handled automatically)
                logEvent('Markers fading back in after drag...');
            });
        }

        // Control buttons
        document.getElementById('enableDrag').onclick = function() {
            dragEnabled = true;
            polygons.forEach(polygon => {
                if (polygon.dragging) {
                    polygon.dragging.enable();
                }
            });
            logEvent('Polygon dragging enabled');
        };

        document.getElementById('disableDrag').onclick = function() {
            dragEnabled = false;
            polygons.forEach(polygon => {
                if (polygon.dragging) {
                    polygon.dragging.disable();
                }
            });
            logEvent('Polygon dragging disabled');
        };

        document.getElementById('clearAll').onclick = function() {
            polygons.forEach(polygon => map.removeLayer(polygon));
            polygons = [];
            logEvent('All polygons cleared');
        };

        document.getElementById('addSample').onclick = function() {
            const samplePoints = [
                [59.3293, 18.0686],
                [59.3393, 18.0786],
                [59.3493, 18.0686],
                [59.3393, 18.0586]
            ];
            
            const polygon = L.polygon(samplePoints, {
                color: '#50622b',
                fillColor: '#b4cd8a',
                fillOpacity: 0.5
            }).addTo(map);
            
            if (dragEnabled) {
                enablePolygonDragging(polygon);
            }
            
            polygons.push(polygon);
            logEvent('Added sample polygon');
        };

        // Initial log
        logEvent('Map initialized with polygon drag functionality');
        logEvent('Click the draw button (‚úèÔ∏è) to start drawing');
    </script>
</body>
</html>
