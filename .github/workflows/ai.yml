name: AI Pull Request Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  ai-review:
    # Körs bara om det är "rätt" repo och målet är main
    if: >
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.event.pull_request.base.ref == 'main'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Query AI for review
        # FIX: Inga ${{ }} här i 'if'
        if: secrets.OPENAI_API_KEY != ''
        env:
          # Här MÅSTE vi dock ha ${{ }} för att sätta miljövariabeln
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          set -e
          BASE_BRANCH="${{ github.base_ref }}"

          # 1. Hämta diff, exkludera låsfiler och annat skräp
          git diff "origin/${BASE_BRANCH}...HEAD" -- . ':(exclude)package-lock.json' ':(exclude)yarn.lock' ':(exclude)*.svg' > pr.diff

          # Avbryt om diffen är tom
          if [ ! -s pr.diff ]; then
            echo "No relevant changes to review."
            exit 0
          fi

          # 2. Storlekskontroll (trunkera om över 100KB)
          DIFF_SIZE=$(wc -c < pr.diff)
          if [ "$DIFF_SIZE" -gt 100000 ]; then
             echo "Diff is too large ($DIFF_SIZE bytes). Truncating..."
             head -c 100000 pr.diff > pr.diff.tmp && mv pr.diff.tmp pr.diff
             echo -e "\n... (Diff truncated due to size) ..." >> pr.diff
          fi

          SYSTEM_PROMPT="You are a senior TypeScript / Leaflet / GIS code reviewer. Always write the entire PR review in clear, professional English regardless of the author's language. Provide concise, helpful, actionable feedback."
          USER_PROMPT_INTRO="Review this diff and comment on potential issues, improvements, and risks:\n\n"

          # 3. Funktion för att bygga JSON säkert med jq
          build_payload() {
            local model="$1"
            jq -n \
              --arg model "$model" \
              --arg system "$SYSTEM_PROMPT" \
              --arg intro "$USER_PROMPT_INTRO" \
              --rawfile diff_content pr.diff \
              '{
                model: $model,
                messages: [
                  { role: "system", content: $system },
                  { role: "user", content: ($intro + $diff_content) }
                ]
              }'
          }

          call_api() {
            local payload="$1"
            curl -s https://api.openai.com/v1/chat/completions \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer ${OPENAI_API_KEY}" \
              -d "$payload"
          }

          # 4. Modell-val och Fallback-logik
          PRIMARY_MODEL="gpt-5.1"
          FALLBACK_MODEL="gpt-5-mini"

          echo "Attempting review with $PRIMARY_MODEL..."
          PRIMARY_PAYLOAD=$(build_payload "$PRIMARY_MODEL")
          RESPONSE=$(call_api "$PRIMARY_PAYLOAD")

          # Om primär modell misslyckas (t.ex. rate limit eller 404), kör fallback
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "Primary model failed. Switching to fallback: $FALLBACK_MODEL"
            FALLBACK_PAYLOAD=$(build_payload "$FALLBACK_MODEL")
            RESPONSE=$(call_api "$FALLBACK_PAYLOAD")
          fi

          # Om det fortfarande är fel -> avsluta med felkod
          if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
            echo "Error from OpenAI API:"
            echo "$RESPONSE" | jq '.'
            exit 1
          fi

          # Spara svaret
          echo "$RESPONSE" | jq -r '.choices[0].message.content' > review.md

      - name: Post review as PR comment
        # FIX: Inga ${{ }} här heller i 'if'
        if: secrets.OPENAI_API_KEY != '' && hashFiles('review.md') != ''
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ai-review
          path: review.md
